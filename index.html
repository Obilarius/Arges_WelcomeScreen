<!DOCTYPE html>
<html lang="de" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Welcome Page</title>
  </head>
  <body>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/index.css">

    <div class="sidebar">
      <img src="img/arges_welcome_monitor_bildleiste.jpg" alt="">
    </div>
    <div class="header">
      <span>Welcome to </span><span style="font-weight: 700">ARGES</span>
    </div>

    <table>
      <thead>
        <tr>
          <td class="widthCol1">
            <img src="img/arges_welcome_monitor_sehstrahl_links.png" alt="">
          </td>

          <!-- DYNAMISCHES DATUM -->
          <td class="col2 font42 widthCol2" id="date">Datum</td>
          <td class="widthCol3">
            <img src="img/arges_welcome_monitor_sehstrahl_rechts.png" alt="">
          </td>
        </tr>
      </thead>
      <tbody id="dynTermin">

        <!-- AB HIER MUSS DYNAMISCH BEFÜLLT WERDEN -->
        <!-- <tr class="dynTr">
          <td class="col col1">08:30</td>
          <td class="col col2">
            <ul>
              <li><span class="userRegisterLink" data-toggle="modal" data-target="#registerModalCenter" data-name="Herr Kalimero van Kallenbach" data-company="Technolas Perfect Vision GmbH">Mr. Kalimero van Kallenbach</span></li>
              <li><span class="userRegisterLink" data-toggle="modal" data-target="#registerModalCenter" data-name="Mr. Kallenbach" data-company="Technolas Perfect Vision GmbH">Mr. Kallenbach</span></li>
              <li><span class="userRegisterLink" data-toggle="modal" data-target="#registerModalCenter" data-name="Mr. Langhals" data-company="Technolas Perfect Vision GmbH">Mr. Langhals</span></li>
              <li><span class="userRegisterLink" data-toggle="modal" data-target="#registerModalCenter" data-name="Mr. Sawtzki" data-company="Technolas Perfect Vision GmbH">Mr. Sawetzki</span></li>
              <li><span class="userRegisterLink" data-toggle="modal" data-target="#registerModalCenter" data-name="Mr. Kallenbach" data-company="Technolas Perfect Vision GmbH">Mr. Kallenbach</span></li>
              <li><span class="userRegisterLink" data-toggle="modal" data-target="#registerModalCenter" data-name="Mr. Bambidibu" data-company="Technolas Perfect Vision GmbH">Mr. Bambidibu</span></li>
            </ul>
          </td>
          <td class="col col3">Technolas Perfect Vision GmbH sdouhwr</td>
          <td class="col col4">
            <img src="http://intranet/SiteCollectionImages/WelcomeLogo/TPV.png" alt="">
          </td>
        </tr>

        <tr class="dynTr">
          <td class="col col1">10:30</td>
          <td class="col col2"></td>
          <td class="col col3">Fartwind</td>
          <td class="col col4">
            <img src="https://www.fartwind.de/fartwind.jpg" alt="">
          </td>
        </tr>

        <tr class="dynTr">
          <td class="col col1">16:00</td>
          <td class="col col2">
            <ul>
              <li><span class="userRegisterLink" data-toggle="modal" data-target="#registerModalCenter" data-name="Herr Walzenbach" data-company="Echsenmensch Inc.">Herr Walzenbach</span></li>
              <li><span class="userRegisterLink" data-toggle="modal" data-target="#registerModalCenter" data-name="Herr Weiss" data-company="Echsenmensch Inc.">Herr Weiss</span></li>
            </ul>
          </td>
          <td class="col col3">Echsenmensch Inc.</td>
          <td class="col col4">
            <img src="https://www.echsenmensch.de/echsenmensch.jpg" alt="">
          </td>
        </tr> -->
        <!-- /ENDE DYNAMISCHER INHALT -->

      </tbody>
    </table>



    <!-- ANMELDUNG -->
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary btnRegister font42" data-toggle="modal" data-target="#registerModalCenter">
      REGISTRATION
    </button>

    <!-- Modal -->
    <div class="modal fade" id="registerModalCenter" tabindex="-1" role="dialog" aria-labelledby="registerModalCenterTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="registerModalLongTitle">Registration</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <input class="form-control form-control-lg inputName" type="text" placeholder="Name">
              </div>
              <div class="form-group">
                <input class="form-control form-control-lg inputCompany" type="text" placeholder="Company">
              </div>
              <div class="form-group">
                <input class="form-control form-control-lg inputAppointment" type="text" placeholder="Appointment at">
              </div>
            </form>

          </div>
          <div class="modal-footer">
            <!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button> -->
            <button type="button" class="btn btn-primary" id="btnRegisterCheckIn">Register</button>
          </div>
        </div>
      </div>
    </div>



  </body>

  <script type="text/javascript" src="script/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="script/bootstrap.js"></script>
  <script type="text/javascript" src="script/ObjTree.js"></script>
  <script type="text/javascript" src="script/func.js"></script>
  <script type="text/javascript">

  let datum = getDatumLang();

  $( document ).ready(function() {
    $("#date").html(datum);

    $('#registerModalCenter').on('show.bs.modal', function (event) {
      let button = $(event.relatedTarget) // Button that triggered the modal

      if (button[0].className == "userRegisterLink") {
        let name = button.data('name') // Extract info from data-* attributes
        let company = button.data('company')

        // Update the modal's content.
        let modal = $(this)
        modal.find('.modal-title').text('Welcome ' + name)
        modal.find('.modal-body .inputName').val(name).attr("readonly", true)
        modal.find('.modal-body .inputCompany').val(company).attr("readonly", true)
      } else {
        // Update the modal's content.
        let modal = $(this)
        modal.find('.modal-title').text("Welcome to ARGES")
        modal.find('.modal-body .inputName').val("").attr("readonly", false)
        modal.find('.modal-body .inputCompany').val("").attr("readonly", false)
      }
    })

    $('#btnRegisterCheckIn').on('click', function (event) {
      // TODO: CheckIn in SQL Datenbank eintragen und ID auslesen
      $.post("mysql.php",
      {
          name: "Donald Duck",
          company: "Duckburg"
      }, function(data, status){
        console.log(data);
      });

      // TODO: Barcodeinhalt dynamisch übergeben
      // TODO: Print auf neuen Drucker (print.html) umleiten
      // let url = 'printTest.html?name=' + $('.modal-body .inputName').val() + '&company=' + $('.modal-body .inputCompany').val() + '&date=' + getDatum() + '&code=' + "6042_TestDataMatrix";
      // window.open( url, 'winPrint', 'width=210,height=80,resizeable=0,scrollable=0,menubar=0,status=0,top=0');

      $('#registerModalCenter').modal('hide');

    })


    // DYNAMISCHE TERMINE

    // XML EINLESEN
    // window.setInterval(function()  {
      jQuery.get("TEST_ARGESVisitorsList.xml", function(data)  {
        xotree = new XML.ObjTree()
        var jsonObj = xotree.parseXML( data );
        jsonObj = jsonObj.Report.table1.Detail_Collection.Detail

        $("#dynTermin").html("");
        $.each(jsonObj, function( key, termin ) {
          // console.log(termin);

          var terminTemplate = '<tr class="dynTr"><td class="col col1">'+ termin._Start_Time +'</td><td class="col col2"><ul>';

          // NAME PARSEN
          const regex = /div>(.*?)<\/div/gm;
          let m;
          while ((m = regex.exec(termin._Visitors)) !== null) {
              // This is necessary to avoid infinite loops with zero-width matches
              if (m.index === regex.lastIndex) {
                  regex.lastIndex++;
              }
              // The result can be accessed through the `m`-variable.
              m.forEach((name, groupIndex) => {
                if (groupIndex == 1) {
                  // console.log(termin._Company);

                  let company = termin._Company.replace(/[<br>]*<[/]*div[^>]*>/gi, "");
                  company = company.replace(/<[/]*br[^>]*>/gi, " - ");
                  // console.log(company);

                  terminTemplate += '<li><span class="userRegisterLink" data-toggle="modal" data-target="#registerModalCenter"';
                  terminTemplate += 'data-name="'+ name +'" data-company="'+ company +'">'+ name +'</span></li>';
                }
              });
          }

          terminTemplate += '</ul></td><td class="col col3">'+ termin._Company +'</td><td class="col col4"><img src="'+ termin._WelcomeLogo +'" alt=""></td></tr>';

          $("#dynTermin").append(terminTemplate);
        })
      }, "text");
    // ENDE DYNAMISCHE TERMINE
    // }, 1000);



  });

  </script>
</html>
