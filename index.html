<!DOCTYPE html>
<html lang="de" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Welcome Page</title>
  </head>
  <body>
    <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"> -->
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/index.css">

    <div class="sidebar">
      <img src="img/arges_welcome_monitor_bildleiste2.jpg" alt="">
    </div>
    <div class="header">
      <span>Welcome to </span><span style="font-weight: 700">ARGES</span>
    </div>

    <table>
      <thead>
        <tr>
          <td class="widthCol1">
            <img src="img/arges_welcome_monitor_sehstrahl_links.png" alt="">
          </td>

          <!-- DYNAMISCHES DATUM -->
          <td class="col2 font42 widthCol2" id="date">Datum</td>
          <td class="widthCol3">
            <img src="img/arges_welcome_monitor_sehstrahl_rechts_lang.png" alt="">
          </td>
        </tr>
      </thead>
      <tbody id="dynTermin">
        <!-- Dynamische Termine werden hier erstellt -->
      </tbody>
    </table>

    <div class="registerDescription">Click name or Button for Registration</div>

    <!-- REGISTER BUTTON -->
    <button type="button" class="btn btn-primary btnRegister font42" data-toggle="modal" data-target="#registerModalCenter">REGISTRATION<i></i></button>

    <!-- CHECKOUT BUTTON -->
    <button type="button" class="btn btn-primary btnCheckOut font42" data-toggle="modal" data-target="#checkOutModalCenter">CHECKOUT</button>

    <!-- REGISTER MODAL -->
    <div class="modal fade" id="registerModalCenter" tabindex="-1" role="dialog" aria-labelledby="registerModalCenterTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="registerModalLongTitle">Registration</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form novalidate>
              <div class="form-group">
                <input class="form-control form-control-lg inputName" type="text" placeholder="*Name">
              </div>
              <div class="form-group">
                <input class="form-control form-control-lg inputCompany" type="text" placeholder="*Company / Firma">
              </div>
              <div class="form-group">
                <input class="form-control form-control-lg inputAppointment" type="text" placeholder="Host / Gastgeber">
              </div>
            </form>

          </div>
          <div class="modal-footer">
            <!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button> -->
            <button type="button" class="btn btn-primary" id="btnRegisterCheckIn">Register</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div class="modal fade" id="checkOutModalCenter" tabindex="-1" role="dialog" aria-labelledby="checkOutModalCenterTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="checkOutModalLongTitle">CheckOut</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body checkout-body">
            <div class="checkout-msg"></div>
            <form class="checkout-form">
              <div class="form-group">
                <input class="form-control form-control-lg inputCheckOutId" type="text" placeholder="VisitorID">
              </div>
            </form>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="btnRegisterCheckOut">CheckOut</button>
          </div>
        </div>
      </div>
    </div>


  </body>

  <script type="text/javascript" src="script/jquery-3.3.1.min.js"></script>
  <script type="text/javascript" src="script/bootstrap.js"></script>
  <script type="text/javascript" src="script/ObjTree.js"></script>
  <script type="text/javascript" src="script/hashid/hashids.min.js"></script>
  <script type="text/javascript" src="script/func.js"></script>
  <script type="text/javascript">

  let datum = getDatumLang();

  $( document ).ready(function() {
    $("#date").html(datum);
    dynAppointment(); // Initiale befüllung mit Terminen

    // REGISTER MODAL SHOW FUNCTION
    $('#registerModalCenter').on('show.bs.modal', function (event) {
      $('.inputName').focus();
      var button = $(event.relatedTarget); // Button that triggered the modal

      $('.modal-body .inputName').removeClass("is-invalid");
      $('.modal-body .inputCompany').removeClass("is-invalid");

      if (button[0].className == "userRegisterLink") {
        let name = button.data('name') // Extract info from data-* attributes
        let company = button.data('company')
        let host = button.data('host')
        let appID = button.data('appID')
        let location = button.data('location')

        // Update the modal's content.
        let modal = $(this)
        modal.find('.modal-title').text('Welcome ' + name)
        modal.find('.modal-body .inputName').val(name).attr("readonly", true)
        modal.find('.modal-body .inputCompany').val(company).attr("readonly", true)
        if (host) {
          modal.find('.modal-body .inputAppointment').val(host).attr("readonly", true)
        } else {
          modal.find('.modal-body .inputAppointment').val("").attr("readonly", false)
        }
        modal.find('.modal-body').data({ appID: button.data('appid'), location: button.data('location'), host: button.data('host') });
      } else {
        // Update the modal's content.
        let modal = $(this)
        modal.find('.modal-title').text("Welcome to ARGES")
        modal.find('.modal-body .inputName').val("").attr("readonly", false)
        modal.find('.modal-body .inputCompany').val("").attr("readonly", false)
        modal.find('.modal-body .inputAppointment').val("").attr("readonly", false)
        modal.find('.modal-body').data({ appID: "", location: "", host: "" });
      }
    })
    // REGISTER MODAL SET FOCUS
    $('#registerModalCenter').on('shown.bs.modal', function (event) {
      if ($('.modal-body .inputName').val() == "") {
        $('.inputName').focus();
      }
    })

    // REGISTER MODAL BUTTON ## INSERT IN DATENBANK UND ERZEUGT DAS LABEL
    $('#btnRegisterCheckIn').on('click', function (event) {
      var name = $('.modal-body .inputName').val();
      var company = $('.modal-body .inputCompany').val();
      var host = $('.modal-body .inputAppointment').val();

      if ( name == "" || company == "" ) {
        if ( name == "" ) {
          $('.modal-body .inputName').addClass("is-invalid");
        }
        if ( company == "" ) {
          $('.modal-body .inputCompany').addClass("is-invalid");
        }
      } else {
        if (host == "debug") {
          // ÜBERGABE AN DIE DRUCKFUNKTION ## ID BEINHALTET DIE ID DES GERADE EINGETRAGENEN DATENSATZES ZÜRÜCK
          var n = encodeURIComponent($('.modal-body .inputName').val());
          var c = encodeURIComponent($('.modal-body .inputCompany').val());

          var url = 'print.html';
          url += '?name=' + n;
          url += '&company=' + c;
          url += '&date=' + getDatum();
          url += '&debug=true';

          window.open( url, 'winPrint', '');
          $('#registerModalCenter').modal('hide');
        } else {
          // ÜBERGABE AN DIE DATENBANK
          $.post("mssql.php",
          {
              name: $('.modal-body .inputName').val(),
              company: $('.modal-body .inputCompany').val(),
              appid: $('.modal-body').data("appID"),
              location: $('.modal-body').data("location"),
              host: $('.modal-body .inputAppointment').val()
          }, function(id, status){
            // ÜBERGABE AN DIE DRUCKFUNKTION ## ID BEINHALTET DIE ID DES GERADE EINGETRAGENEN DATENSATZES ZÜRÜCK
            var n = encodeURIComponent($('.modal-body .inputName').val());
            var c = encodeURIComponent($('.modal-body .inputCompany').val());

            var url = 'print.html';
            url += '?name=' + n;
            url += '&company=' + c;
            url += '&date=' + getDatum();
            url += '&code=' + $.trim(id);
            if ($('.modal-body .inputAppointment').val()) {
              var h = encodeURIComponent($('.modal-body .inputAppointment').val());
              url += '&host=' + h;
            }

            window.open( url, 'winPrint', 'width=210,height=80,resizeable=0,scrollable=0,menubar=0,status=0,top=0');
          });
          $('#registerModalCenter').modal('hide');
        }
      } //End If Debug
    })

    // CHECKOUT MODAL SHOW FUNCTION
    $('#checkOutModalCenter').on('shown.bs.modal', function (event) {
      var button = $(event.relatedTarget) // Button that triggered the modal
      $('.inputCheckOutId').focus();

      // Update the modal's content.
      let modal = $(this)
      modal.find('.checkout-body .inputCheckOutId').val("").show();
      modal.find('.checkout-body .checkout-msg').html("").hide();
    })

    // CHECKOUT MODAL BUTTON ## UPDATE IN DATENBANK
    $('#btnRegisterCheckOut').on('click', function (event) {
      var hashids = new Hashids("this is my salt", 6, "1234567890ABCDEF");
      var id = hashids.decode( $('.modal-body .inputCheckOutId').val().trim() );
      // ÜBERGABE AN DIE DATENBANK
      $.post("mssql.php", { visitorid: id[0] }, function(data){
        $('.checkout-body .inputCheckOutId').val("").hide();

        if (data == 1) {
          $('.checkout-body .checkout-msg').html("You have been successfully logged out").show();
        } else {
          $('.checkout-body .checkout-msg').html("You are already logged out").show();
        }
      });

      window.setTimeout(function(){
         $('#checkOutModalCenter').modal('hide');
      }, 1500);
    })


    // DYNAMISCHE TERMINE MIT INTERVAL
    window.setInterval(function()  {
      dynAppointment();
    }, 60000);

  }); // Ende Document Ready

  function dynAppointment () {
    $.post("readFile.php",
    {
      url: "//filer/Public/Datenbankentwicklung/ARGESVisitors/ARGESVisitorsList.xml"
    }, function(data, status){
      xotree = new XML.ObjTree()
      var jsonObj = xotree.parseXML( data );
      if (!jsonObj.Report.table1) {
        return;
        // Hier Funktion wenn keine Termine in XML sind
      }
      jsonObj = jsonObj.Report.table1.Detail_Collection.Detail

      if (!Array.isArray(jsonObj)) {
        var temp = jsonObj;
        var jsonObj = new Array;
        jsonObj.push(temp);
      }

      $("#dynTermin").html("");
      $.each(jsonObj, function( key, termin ) {
        var terminTemplate = '<tr class="dynTr"><td class="col col1">'+ termin._Start_Time +'</td><td class="col col2"><ul>';

        // NAME IN ARRAY ZERLEGEN
        if ( typeof(termin._Visitors) != "undefined" ) {
          var names = termin._Visitors.replace( /\r\n/gm, "#" ).split("#");
        } else {
          var names = [];
        }

        names.forEach( function(name) {
          let company = termin._Company.replace(/[<br>]*<[/]*div[^>]*>/gi, "");
          company = company.replace(/<[/]*br[^>]*>/gi, " - ");
          let host = ( typeof termin._Host === "undefined" ? null : termin._Host.trim() )

          terminTemplate += '<li><span class="userRegisterLink" data-toggle="modal" data-target="#registerModalCenter"';
          terminTemplate += 'data-name="'+ name +'"';
          terminTemplate += 'data-company="'+ company +'"';
          terminTemplate += 'data-appid="'+ termin._ID +'"';
          terminTemplate += 'data-location="'+ termin._Location +'"';
          terminTemplate += 'data-host="'+ host +'"';
          terminTemplate += 'data-host="Host Name"';

          terminTemplate += '>'+ name +'</span></li>';
        });

        terminTemplate += '</ul></td><td class="col col3">'+ termin._Company +'</td><td class="col col4"><img src="'+ termin._WelcomeLogo +'" alt=""></td></tr>';

        $("#dynTermin").append(terminTemplate);
      })
    });
  } // Ende dynAppointment

  </script>
</html>
